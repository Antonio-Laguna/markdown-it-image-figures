{"version":3,"file":"markdown-it-images-figures.js","sources":["../src/index.js"],"sourcesContent":["'use strict';\n\nfunction removeAttributeFromList(attrs, attribute) {\n  const arr = Array.isArray(attrs) ? attrs : [];\n\n  return arr.filter(([k]) => k !== attribute);\n}\n\nfunction removeAttributeFromImage(image, attribute) {\n  if (image && image.attrs) {\n    image.attrs = removeAttributeFromList(image.attrs, attribute);\n  }\n}\n\nmodule.exports = function imageFiguresPlugin(md, options) {\n  options = options || {};\n\n  function imageFigures(state) {\n    // reset tabIndex on md.render()\n    let tabIndex = 1;\n\n    // do not process first and last token\n    for (let i = 1, l = state.tokens.length; i < (l - 1); ++i) {\n      const token = state.tokens[i];\n\n      if (token.type !== 'inline') {\n        continue;\n      }\n      // children: image alone, or link_open -> image -> link_close\n      if (!token.children || (token.children.length !== 1 && token.children.length !== 3)) {\n        continue;\n      }\n      // one child, should be img\n      if (token.children.length === 1 && token.children[0].type !== 'image') {\n        continue;\n      }\n      // three children, should be image enclosed in link\n      if (token.children.length === 3) {\n        const [childrenA, childrenB, childrenC] = token.children;\n        const isEnclosed = childrenA.type !== 'link_open' ||\n          childrenB.type !== 'image' ||\n          childrenC.type !== 'link_close';\n\n        if (isEnclosed) {\n          continue;\n        }\n      }\n      // prev token is paragraph open\n      if (i !== 0 && state.tokens[i - 1].type !== 'paragraph_open') {\n        continue;\n      }\n      // next token is paragraph close\n      if (i !== (l - 1) && state.tokens[i + 1].type !== 'paragraph_close') {\n        continue;\n      }\n\n      // We have inline token containing an image only.\n      // Previous token is paragraph open.\n      // Next token is paragraph close.\n      // Lets replace the paragraph tokens with figure tokens.\n      const figure = state.tokens[i - 1];\n      figure.type = 'figure_open';\n      figure.tag = 'figure';\n      state.tokens[i + 1].type = 'figure_close';\n      state.tokens[i + 1].tag = 'figure';\n\n      if (options.dataType) {\n        state.tokens[i - 1].attrPush(['data-type', 'image']);\n      }\n      let image;\n\n      if (options.link && token.children.length === 1) {\n        [image] = token.children;\n        const link = new state.Token('link_open', 'a', 1);\n        link.attrPush(['href', image.attrGet('src')]);\n\n        token.children.unshift(link);\n        token.children.push(new state.Token('link_close', 'a', -1));\n      }\n\n      // for linked images, image is one off\n      image = token.children.length === 1 ? token.children[0] : token.children[1];\n\n      if (options.figcaption) {\n        let figCaption;\n        const captionObj = image.attrs.find(([k]) => k === 'title');\n\n        if (Array.isArray(captionObj)) {\n          figCaption = captionObj[1];\n        }\n\n        if (figCaption) {\n          const [captionContent] = md.parseInline(figCaption, state.env);\n          token.children.push(\n            new state.Token('figcaption_open', 'figcaption', 1)\n          );\n          token.children.push(...captionContent.children);\n          token.children.push(\n            new state.Token('figcaption_close', 'figcaption', -1)\n          );\n\n          if (image.attrs) {\n            image.attrs = removeAttributeFromList(image.attrs, 'title');\n          }\n        }\n      }\n\n      if (options.copyAttrs && image.attrs) {\n        const f = options.copyAttrs === true ? '' : options.copyAttrs;\n        // Copying so any further changes aren't duplicated\n        figure.attrs = image.attrs\n          .filter(([k]) => k.match(f))\n          .map(a => Array.from(a));\n      }\n\n      if (options.tabindex) {\n        // add a tabindex property\n        // you could use this with css-tricks.com/expanding-images-html5\n        state.tokens[i - 1].attrPush(['tabindex', tabIndex]);\n        tabIndex++;\n      }\n\n      if (options.lazy) {\n        const hasLoading = image.attrs.some(([attribute]) => attribute === 'loading');\n\n        if (!hasLoading) {\n          image.attrs.push(['loading', 'lazy']);\n        }\n      }\n\n      if (options.async) {\n        const hasDecoding = image.attrs.some(([attribute]) => attribute === 'decoding');\n\n        if (!hasDecoding) {\n          image.attrs.push(['decoding', 'async']);\n        }\n      }\n\n      if (options.classes && typeof options.classes === 'string') {\n        let hasClass = false;\n\n        for (let j = 0, length = image.attrs.length; j < length && !hasClass; j++) {\n          const attrPair = image.attrs[j];\n\n          if (attrPair[0] === 'class') {\n            attrPair[1] = `${attrPair[1]} ${options.classes}`;\n            hasClass = true;\n          }\n        }\n\n        if (!hasClass) {\n          image.attrs.push(['class', options.classes]);\n        }\n      }\n\n      if (options.removeSrc) {\n        const src = image.attrs.find(([k]) => k === 'src');\n        image.attrs.push(['data-src', src[1]]);\n        removeAttributeFromImage(image, 'src');\n      }\n    }\n  }\n\n  md.core.ruler.before('linkify', 'image_figures', imageFigures);\n};\n"],"names":["removeAttributeFromList","attrs","attribute","Array","isArray","filter","removeAttributeFromImage","image","module","exports","md","options","core","ruler","before","state","tabIndex","i","l","tokens","length","token","type","children","figure","tag","dataType","attrPush","link","Token","attrGet","unshift","push","figcaption","figCaption","captionObj","find","captionContent","parseInline","env","copyAttrs","f","match","map","a","from","tabindex","lazy","some","async","classes","hasClass","j","attrPair","removeSrc","src"],"mappings":"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"}